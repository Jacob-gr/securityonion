{% import_yaml 'versionlock/defaults.yaml' as VERSIONLOCKDEFAULTS %}
{% set VERSIONLOCKMERGED = salt['pillar.get']('versionlock', VERSIONLOCKDEFAULTS.versionlock, merge=True) %}
{% set HELD = salt['pkg.list_holds']() %}

{% set PACKAGES_HELD_IN_OTHER_STATES = [
   'salt',
   'salt-master',
   'salt-minion',
   'containerd.io',
   'docker-ce',
   'docker-ce-cli',
   'docker-ce-rootless-extras'
] %}

{% if VERSIONLOCKMERGED.kernel %}
    {% do VERSIONLOCKMERGED['hold'].append('kernel') %}
{% endif %}

{# remove packages held in other states from hold list #}
{% do VERSIONLOCKMERGED.update({'hold': VERSIONLOCKMERGED['hold'] | unique | reject('in', PACKAGES_HELD_IN_OTHER_STATES) | list }) %}

{% do VERSIONLOCKMERGED.update({'UNHOLD': []}) %}

{# if a package is currently held but not set to be held, unhold it #}
{% for item in HELD %}
    {% set base_name = item.rsplit('-', 2)[0] %}
    {% if base_name not in VERSIONLOCKMERGED['hold']
       and base_name not in PACKAGES_HELD_IN_OTHER_STATES
       and base_name not in VERSIONLOCKMERGED['UNHOLD'] %}
        {% do VERSIONLOCKMERGED['UNHOLD'].append(base_name) %}
    {% endif %}
{% endfor %}
