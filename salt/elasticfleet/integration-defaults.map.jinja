{# Copyright Security Onion Solutions LLC and/or licensed to Security Onion Solutions LLC under one
  or more contributor license agreements. Licensed under the Elastic License 2.0; you may not use
  this file except in compliance with the Elastic License 2.0. #}


{% import_json '/opt/so/state/esfleet_package_components.json' as ADDON_PACKAGE_COMPONENTS %}
{% import_yaml 'elasticfleet/defaults.yaml' as ELASTICFLEETDEFAULTS %}
{% import_yaml 'elasticfleet/integration-defaults.yaml' as INTEGRATIONDEFAULTS %}

{% set CORE_ESFLEET_PACKAGES = ELASTICFLEETDEFAULTS.get('elasticfleet', {}).get('packages', {}) %}
{% set ADDON_INTEGRATION_DEFAULTS = {} %}

{% for pkg in ADDON_PACKAGE_COMPONENTS %}
{%   if pkg.name in CORE_ESFLEET_PACKAGES %}
{#     skip core integrations #}
{%   elif pkg.name not in CORE_ESFLEET_PACKAGES %}
{#     generate defaults for each integration #}
{%     if pkg.es_index_patterns is defined and pkg.es_index_patterns is not none %}
{%       for pattern in pkg.es_index_patterns %}
{%         set integration_key = "so-logs-" ~ pkg.name ~ "_x_" ~ pattern.title %}
{%         set integration_defaults = {
              "index_sorting": false,
              "index_template": {
                  "composed_of": ["logs-" ~ pkg.name ~ "." ~ pattern.title ~ "@package", "logs-" ~ pkg.name ~ "." ~ pattern.title ~ "@custom", "so-fleet_globals-1", "so-fleet_agent_id_verification-1"],
                  "data_stream": {
                      "hidden": false,
                      "allow_custom_routing": false
                  },
                  "ignore_missing_component_templates": ["logs-" ~ pkg.name ~ "." ~ pattern.title ~ "@custom"],
                  "index_patterns": [pattern.name],
                  "priority": 501,
                  "template": {
                      "settings": {
                          "index": {
                              "lifecycle": {"name": "so-logs-" ~ pkg.name ~ "." ~ pattern.title ~ "-logs"},
                              "number_of_replicas": 0
                          }
                      }
                  }
              },
              "policy": {
                  "phases": {
                      "cold": {
                          "actions": {
                              "set_priority": {"priority": 0}
                          },
                          "min_age": "60d"
                      },
                      "delete": {
                          "actions": {
                              "delete": {}
                          },
                          "min_age": "365d"
                      },
                      "hot": {
                          "actions": {
                              "rollover": {
                                  "max_age": "30d",
                                  "max_primary_shard_size": "50gb"
                              },
                              "set_priority": {"priority": 100}
                          },
                          "min_age": "0ms"
                      },
                      "warm": {
                          "actions": {
                              "set_priority": {"priority": 50}
                          },
                          "min_age": "30d"
                      }
                  }
              }
          } %}
{%         do ADDON_INTEGRATION_DEFAULTS.update({integration_key: integration_defaults}) %}
{%       endfor %}
{%     endif %}
{%   endif %}
{% endfor %}